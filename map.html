<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Sync // מפת בובות מקומיות</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Heebo:wght@300;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --neon-pink: #ff00ff;
            --neon-cyan: #00ffff;
            --bg-black: #020005;
            --glass: rgba(13, 2, 33, 0.96);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: var(--bg-black); color: white;
            font-family: 'Orbitron', 'Heebo', sans-serif;
            overflow: hidden;
            direction: rtl;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Grid background effect */
        .bg-grid {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image:
                linear-gradient(rgba(0,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,255,255,0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: 1;
            pointer-events: none;
        }

        /* Scan line effect */
        .scan-line {
            position: fixed; top: 0; left: 0; width: 100%; height: 4px;
            background: rgba(0, 255, 255, 0.2);
            box-shadow: 0 0 20px var(--neon-cyan);
            z-index: 2;
            animation: scanMove 8s linear infinite;
            opacity: 0.5;
        }

        @keyframes scanMove {
            0% { top: -5%; }
            100% { top: 105%; }
        }

        /* Header - compact version */
        .map-header {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            text-align: center;
            padding: 8px 20px;
            background: var(--glass);
            border: 2px solid var(--neon-cyan);
            box-shadow: 0 0 30px var(--neon-cyan);
            border-radius: 10px;
        }

        .map-header h1 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--neon-cyan);
            text-shadow: 0 0 10px var(--neon-cyan);
        }

        .map-header p {
            display: none; /* Hide subtitle to save space */
        }

        /* Map container */
        .map-container {
            position: relative;
            display: inline-block;
            border: 3px solid var(--neon-pink);
            border-radius: 15px;
            box-shadow: 0 0 40px var(--neon-pink);
            z-index: 10;
        }

        #main-map {
            height: 92vh;
            display: block;
            border-radius: 10px;
        }

        /* Doll photos on map */
        .user-photo-wrapper {
            position: absolute;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 100;
            animation: fadeIn 0.8s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        /* Neon twinkle effect */
        @keyframes neonTwinkle {
            0%, 100% {
                filter: drop-shadow(0 0 5px var(--neon-cyan))
                        drop-shadow(0 0 10px var(--neon-cyan));
            }
            50% {
                filter: drop-shadow(0 0 10px var(--neon-pink))
                        drop-shadow(0 0 20px var(--neon-pink));
            }
        }

        .user-photo-wrapper img {
            width: 35px;
            height: 45px;
            object-fit: contain;
            background: transparent;
            border: none;
            animation: neonTwinkle 3s infinite ease-in-out;
            transition: all 0.3s ease;
        }

        /* Clustered dolls (when multiple dolls in same city) */
        .user-photo-wrapper.in-cluster img {
            width: 28px;
            height: 38px;
        }

        /* City name label */
        .city-name {
            display: none;
        }

        /* Back button - compact */
        .back-btn {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 8px 20px;
            background: var(--glass);
            border: 2px solid var(--neon-pink);
            color: var(--neon-pink);
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 10px;
            box-shadow: 0 0 30px var(--neon-pink);
            font-family: 'Orbitron', sans-serif;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: var(--neon-pink);
            color: var(--bg-black);
            box-shadow: 0 0 50px var(--neon-pink);
        }

        /* Responsive design for mobile and tablet */
        @media (max-width: 768px) {
            .map-header {
                top: 5px;
                padding: 5px 15px;
            }

            .map-header h1 {
                font-size: 0.9rem;
            }

            #main-map {
                height: 85vh;
            }

            .back-btn {
                font-size: 0.8rem;
                padding: 6px 15px;
                bottom: 5px;
            }

            .user-photo-wrapper img {
                width: 28px;
                height: 38px;
            }

            .user-photo-wrapper.in-cluster img {
                width: 22px;
                height: 30px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .map-header h1 {
                font-size: 1rem;
            }

            #main-map {
                height: 88vh;
            }

            .user-photo-wrapper img {
                width: 32px;
                height: 42px;
            }

            .user-photo-wrapper.in-cluster img {
                width: 26px;
                height: 35px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    <div class="scan-line"></div>

    <div class="map-container">
        <img src="israel.map.png" id="main-map">
        <div id="photos-layer"></div>
    </div>

    <button class="back-btn" onclick="window.location.href='index.html'">חזרה לפורטל</button>

    <script src="cities.js"></script>
    <script>
        const firebaseConfig = { databaseURL: "https://bubot-mekomiot-default-rtdb.firebaseio.com" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // City coordinates - EXACT coordinates from working bigmap
        const cityCoords = {
            "ירושלים": { left: 52.2, top: 44.7 },
            "תל אביב": { left: 44.0, top: 38.3 },
            "חיפה": { left: 48.1, top: 23.2 },
            "באר שבע": { left: 44.1, top: 55.9 },
            "קרית שמונה": { left: 56.5, top: 12.5 },
            "צפת": { left: 55.5, top: 18.5 },
            "טבריה": { left: 56.1, top: 22.1 },
            "עפולה": { left: 51.5, top: 27.5 },
            "נהריה": { left: 49.5, top: 18.0 },
            "עכו": { left: 49.0, top: 20.0 },
            "כרמיאל": { left: 53.0, top: 19.5 },
            "קריות": { left: 49.2, top: 22.5 },
            "נתניה": { left: 45.4, top: 33.1 },
            "כפר סבא": { left: 47.5, top: 35.8 },
            "רעננה": { left: 46.2, top: 35.5 },
            "הרצליה": { left: 45.0, top: 36.5 },
            "חדרה": { left: 46.5, top: 31.0 },
            "פתח תקווה": { left: 47.2, top: 38.0 },
            "רמת גן": { left: 45.2, top: 37.8 },
            "גבעתיים": { left: 45.1, top: 38.5 },
            "בני ברק": { left: 45.8, top: 37.9 },
            "חולון": { left: 44.5, top: 39.8 },
            "בת ים": { left: 43.8, top: 39.5 },
            "ראשון לציון": { left: 44.8, top: 41.2 },
            "נס ציונה": { left: 44.9, top: 42.5 },
            "רחובות": { left: 45.1, top: 43.8 },
            "מודיעין": { left: 49.5, top: 41.5 },
            "בית שמש": { left: 48.5, top: 46.5 },
            "אשדוד": { left: 41.6, top: 44.2 },
            "אשקלון": { left: 39.5, top: 47.5 },
            "שדרות": { left: 40.5, top: 49.5 },
            "נתיבות": { left: 39.8, top: 52.1 },
            "אופקים": { left: 41.0, top: 53.5 },
            "ערד": { left: 51.5, top: 56.5 },
            "דימונה": { left: 50.5, top: 60.5 },
            "מצפה רמון": { left: 44.5, top: 71.2 },
            "אילת": { left: 47.1, top: 91.4 }
        };

        const activeCitiesCount = {};
        let pendingUploadId = null;

        // Show doll instantly from localStorage, then sync to Firebase in background
        const pending = localStorage.getItem('pendingUpload');
        if (pending) {
            localStorage.removeItem('pendingUpload');
            const pendingData = JSON.parse(pending);
            pendingUploadId = pendingData.uploadId;
            addDollToMap(pendingData);
            database.ref('uploads').push(pendingData);
        }

        database.ref('uploads').limitToLast(30).on('child_added', (snapshot) => {
            const data = snapshot.val();
            // Skip if already shown from localStorage
            if (pendingUploadId && data.uploadId === pendingUploadId) {
                pendingUploadId = null;
                return;
            }
            addDollToMap(data);
        });

        function addDollToMap(data) {
            const coords = cityCoords[data.city];
            if (!coords) return;

            const layer = document.getElementById('photos-layer');

            // Manage queue of 30 dolls
            if (layer.children.length >= 30) {
                const first = layer.firstChild;
                const cityKey = first.getAttribute('data-city');
                if (activeCitiesCount[cityKey]) {
                    activeCitiesCount[cityKey]--;
                }
                layer.removeChild(first);
            }

            const div = document.createElement('div');
            div.className = 'user-photo-wrapper';
            div.setAttribute('data-city', data.city);

            // Dynamic clustering logic
            const count = activeCitiesCount[data.city] || 0;
            activeCitiesCount[data.city] = count + 1;

            const scaleFactor = Math.max(0.5, 1 - (count * 0.1));

            document.querySelectorAll(`.user-photo-wrapper[data-city="${data.city}"] img`).forEach(existingImg => {
                existingImg.style.transform = `scale(${scaleFactor})`;
            });

            const radius = count === 0 ? 0 : 3.5;
            const angle = (count * 60) * (Math.PI / 180);
            const offsetX = Math.cos(angle) * radius;
            const offsetY = Math.sin(angle) * radius;

            div.style.left = (coords.left + offsetX) + '%';
            div.style.top = (coords.top + offsetY) + '%';
            div.style.zIndex = 100 + count;

            div.innerHTML = `
                <img src="${data.image}" style="transform: scale(${scaleFactor})">
            `;
            layer.appendChild(div);
        }
    </script>
</body>
</html>
